<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sama Sana</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">üìÇ Panel de Exportaci√≥n</h1>
        
        <p class="text-gray-600 mb-4">
            Aqu√≠ puedes descargar la lista completa de correos y resultados.
        </p>

        <button id="btnDescargar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded flex items-center gap-2">
            <span>üì• Descargar Lista a Excel (CSV)</span>
        </button>

        <p id="mensaje" class="mt-4 text-sm text-gray-500"></p>
    </div>

    <script type="module">
        // Importamos las herramientas necesarias
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, getDocs } from 'firebase/firestore';

        // --- ‚ö†Ô∏è PEGA AQU√ç TU MISMA CONFIGURACI√ìN (La del index.html) ‚ö†Ô∏è ---
        const firebaseConfig = {
            // ... copia y pega aqu√≠ lo que tienes en tu index.html ...
            // apiKey: "...",
            // authDomain: "...",
            // ...
        };

        // Iniciamos Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Funci√≥n para convertir datos JSON a CSV (formato Excel)
        function convertirACSV(arrayDeDatos) {
            if (arrayDeDatos.length === 0) return '';
            
            // 1. Sacamos los encabezados (las columnas)
            const cabeceras = Object.keys(arrayDeDatos[0]);
            const filas = [cabeceras.join(',')]; // Primera fila: T√≠tulos

            // 2. Recorremos cada paciente y lo convertimos a texto
            arrayDeDatos.forEach(obj => {
                const valores = cabeceras.map(cabecera => {
                    let valor = obj[cabecera] || ''; // Si est√° vac√≠o, poner nada
                    return `"${valor}"`; // Ponemos comillas por si el texto tiene comas
                });
                filas.push(valores.join(','));
            });

            return filas.join('\n'); // Unimos todo con saltos de l√≠nea
        }

        // L√≥gica del Bot√≥n
        document.getElementById('btnDescargar').addEventListener('click', async () => {
            const msj = document.getElementById('mensaje');
            msj.textContent = "‚è≥ Conectando con la base de datos...";
            msj.className = "mt-4 text-sm text-blue-600";

            try {
                // 1. Pedimos los documentos a la colecci√≥n (Aseg√∫rate que el nombre coincida con el que usaste)
                // Si tu colecci√≥n se llama distinto de 'usuarios', c√°mbialo aqu√≠ abajo üëá
                const querySnapshot = await getDocs(collection(db, "leads_dosha"));
                
                const listaPacientes = [];
                querySnapshot.forEach((doc) => {
                    listaPacientes.push(doc.data());
                });

                if (listaPacientes.length === 0) {
                    msj.textContent = "‚ö†Ô∏è La base de datos est√° vac√≠a o no se pudo leer.";
                    return;
                }

                // 2. Convertimos a CSV
                const csvContent = convertirACSV(listaPacientes);

                // 3. Crear un enlace invisible para descargar el archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "reporte_sama_sana.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                msj.textContent = "‚úÖ ¬°Descarga completada con √©xito!";
                msj.className = "mt-4 text-sm text-green-600 font-bold";

            } catch (error) {
                console.error("Error:", error);
                msj.textContent = "‚ùå Error: " + error.message;
                msj.className = "mt-4 text-sm text-red-600";
            }
        });
    </script>
</body>
</html>
