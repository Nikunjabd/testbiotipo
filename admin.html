<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sama Sana</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">üìÇ Panel de Exportaci√≥n</h1>
        
        <p class="text-gray-600 mb-4">
            Aqu√≠ puedes descargar la lista completa de correos y resultados.
        </p>

        <button id="btnDescargar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded flex items-center gap-2">
            <span>üì• Descargar Lista a Excel (CSV)</span>
        </button>

        <p id="mensaje" class="mt-4 text-sm text-gray-500"></p>
    </div>

    <script type="module">
        // Importamos las herramientas necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- TU CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNKkuplVI9rVEN9XbgjpLS_O-kncfCFyA",
            authDomain: "testbiotipo.firebaseapp.com",
            projectId: "testbiotipo",
            storageBucket: "testbiotipo.firebasestorage.app",
            messagingSenderId: "317910027014",
            appId: "1:317910027014:web:1e3429835bc7f1562b6c87",
            measurementId: "G-QLVSK0YQY7"
        };

        // Iniciamos Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FUNCI√ìN PARA CREAR EL CSV ---
        function convertirACSV(arrayDeDatos) {
            if (arrayDeDatos.length === 0) return '';
            
            // 1. TUS COLUMNAS VIP 
            // Aqu√≠ ponemos el nombre del DATO que quieres sacar
            const columnasDeseadas = ["email", "resultType"]; 

            // T√≠tulos de la primera fila
            const filas = [columnasDeseadas.join(',')]; 

            // 2. Rellenamos los datos
            arrayDeDatos.forEach(obj => {
                const valores = columnasDeseadas.map(columna => {
                    let valor = obj[columna] || ''; 
                    return `"${valor}"`; 
                });
                filas.push(valores.join(','));
            });

            return filas.join('\n'); 
        }

        // --- L√ìGICA DEL BOT√ìN ---
        document.getElementById('btnDescargar').addEventListener('click', async () => {
            const msj = document.getElementById('mensaje');
            msj.textContent = "‚è≥ Conectando con la base de datos...";
            msj.className = "mt-4 text-sm text-blue-600";

            try {
                // ‚ö†Ô∏è AQU√ç BUSCAMOS EN LA CARPETA "leads_dosha"
                const querySnapshot = await getDocs(collection(db, "leads_dosha"));
                
                const listaPacientes = [];
                querySnapshot.forEach((doc) => {
                    listaPacientes.push(doc.data());
                });

                if (listaPacientes.length === 0) {
                    msj.textContent = "‚ö†Ô∏è Conectado a 'leads_dosha', pero la carpeta est√° vac√≠a.";
                    return;
                }

                // Generamos el CSV
                const csvContent = convertirACSV(listaPacientes);

                // Descargamos
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "pacientes_leads_dosha.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                msj.textContent = "‚úÖ ¬°Descarga completada con √©xito!";
                msj.className = "mt-4 text-sm text-green-600 font-bold";

            } catch (error) {
                console.error("Error completo:", error);
                msj.textContent = "‚ùå Error: " + error.message;
                msj.className = "mt-4 text-sm text-red-600";
            }
        });
    </script>
</body>
</html>
